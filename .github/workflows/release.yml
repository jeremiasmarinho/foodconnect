name: 🚀 Release Pipeline

on:
  push:
    tags:
      - "v*.*.*" # Triggers on version tags like v1.0.0

env:
  NODE_VERSION: "18.x"

jobs:
  # =====================================
  # Create GitHub Release
  # =====================================
  create-release:
    name: 📦 Create Release
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history for changelog

      - name: 🟢 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: 📋 Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: 📝 Generate changelog
        id: changelog
        run: |
          # Get commits since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            COMMITS=$(git log --pretty=format:"- %s (%h)" --reverse)
          else
            COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)" --reverse)
          fi

          # Create changelog
          CHANGELOG="## 🚀 What's New in ${{ steps.version.outputs.VERSION }}

          ### 📋 Changes:
          $COMMITS

          ### 🧪 Testing:
          - ✅ All unit tests passing
          - ✅ Integration tests passing
          - ✅ E2E tests passing

          ### 📦 Installation:
          \`\`\`bash
          git clone https://github.com/jeremiasmarinho/foodconnect.git
          cd foodconnect
          npm run install:all
          npm run db:setup
          npm run start:dev
          \`\`\`

          ### 🐛 Bug Reports:
          Found a bug? Please [create an issue](https://github.com/jeremiasmarinho/foodconnect/issues/new?template=bug_report.yml)!"

          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: 🏗️ Build Backend
        working-directory: ./backend
        run: |
          npm ci
          npm run build

      - name: 🏗️ Build Frontend (if applicable)
        working-directory: ./frontend
        run: |
          npm ci
          if npm run | grep -q "build"; then
            npm run build
          else
            echo "Frontend build not configured, skipping..."
          fi
        continue-on-error: true

      - name: 📦 Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          release_name: 🚀 FoodConnect ${{ steps.version.outputs.VERSION }}
          body: ${{ steps.changelog.outputs.CHANGELOG }}
          draft: false
          prerelease: ${{ contains(steps.version.outputs.VERSION, '-') }}

      - name: 📊 Release Statistics
        run: |
          echo "🎉 Release ${{ steps.version.outputs.VERSION }} created successfully!"
          echo "📊 Repository Statistics:"
          echo "- Total commits: $(git rev-list --count HEAD)"
          echo "- Contributors: $(git shortlog -sn | wc -l)"
          echo "- Files in release: $(find . -type f -name "*.ts" -o -name "*.js" -o -name "*.tsx" -o -name "*.jsx" | wc -l)"

  # =====================================
  # Notify Team (optional)
  # =====================================
  notify-release:
    name: 📢 Notify Release
    runs-on: ubuntu-latest
    needs: create-release
    if: success()

    steps:
      - name: 📢 Release Notification
        run: |
          echo "🎉 FoodConnect ${{ github.ref_name }} has been released!"
          echo "🔗 View release: https://github.com/jeremiasmarinho/foodconnect/releases/tag/${{ github.ref_name }}"
          echo "📝 Don't forget to update deployment environments!"
